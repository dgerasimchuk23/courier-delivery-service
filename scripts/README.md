# Скрипты для анализа и оптимизации базы данных

В этой директории находятся скрипты для анализа и оптимизации базы данных.

## Скрипты для анализа производительности

### analyze_db.sh (Linux/macOS)

Скрипт для анализа производительности базы данных в Linux/macOS.

#### Использование

```bash
cd scripts
./analyze_db.sh
```

#### Параметры

Параметры подключения к базе данных можно изменить в начале скрипта или передать через переменные окружения:

```bash
DB_HOST=localhost DB_PORT=5432 DB_NAME=delivery DB_USER=postgres DB_PASSWORD=postgres ./analyze_db.sh
```

### analyze_db.bat (Windows)

Скрипт для анализа производительности базы данных в Windows.

#### Использование

```cmd
cd scripts
analyze_db.bat
```

#### Параметры

Параметры подключения к базе данных можно изменить в начале скрипта.

## Что делают скрипты

Скрипты выполняют следующие операции:

1. **Анализ индексов** - проверяют наличие и структуру индексов в базе данных
2. **Анализ размера таблиц** - определяют размер таблиц и индексов
3. **Анализ запросов** - проверяют производительность ключевых запросов
4. **Оптимизация таблицы refresh_tokens**:
   - Удаление просроченных токенов
   - Удаление дубликатов токенов, оставляя только последние 5 для каждого пользователя
5. **Обновление статистики** - обновляют статистику для оптимизатора запросов

## Результаты

Результаты анализа сохраняются в директории `db_analysis_YYYYMMDD_HHMMSS`, где `YYYYMMDD_HHMMSS` - текущая дата и время.

В директории с результатами создаются следующие файлы:

- `indexes.txt` - информация об индексах
- `table_sizes.txt` - размеры таблиц и индексов
- `query_users_*.txt` - анализ запросов к таблице users
- `query_refresh_tokens_*.txt` - анализ запросов к таблице refresh_tokens
- `query_complex_join.txt` - анализ сложных запросов с JOIN
- `locks.txt` - информация о блокировках
- `long_queries.txt` - информация о долгих запросах

## Требования

Для работы скриптов необходимо:

1. PostgreSQL клиент (psql)
2. Доступ к базе данных
3. Права на выполнение запросов EXPLAIN ANALYZE и ANALYZE

## Рекомендации по оптимизации

На основе результатов анализа можно выполнить следующие оптимизации:

1. Добавить недостающие индексы для часто используемых полей
2. Оптимизировать запросы, которые выполняются слишком долго
3. Настроить параметры PostgreSQL для улучшения производительности
4. Регулярно выполнять очистку просроченных токенов
5. Ограничить количество refresh-токенов для каждого пользователя 