# Скрипты для анализа и оптимизации базы данных

В этой директории находятся скрипты для анализа и оптимизации базы данных.

## Скрипты для анализа производительности

### analyze_db.sh (Linux/macOS)

Скрипт для анализа производительности базы данных в Linux/macOS.

#### Использование

```bash
cd scripts
./analyze_db.sh
```

#### Параметры

Параметры подключения к базе данных можно изменить в начале скрипта или передать через переменные окружения:

```bash
DB_HOST=localhost DB_PORT=5432 DB_NAME=delivery DB_USER=postgres DB_PASSWORD=postgres ./analyze_db.sh
```

### analyze_db.bat (Windows)

Скрипт для анализа производительности базы данных в Windows.

#### Использование

```cmd
cd scripts
analyze_db.bat
```

#### Параметры

Параметры подключения к базе данных можно изменить в начале скрипта.

## Что делают скрипты

Скрипты выполняют следующие операции:

1. **Анализ индексов** - проверяют наличие и структуру индексов в базе данных
2. **Анализ размера таблиц** - определяют размер таблиц и индексов
3. **Анализ запросов** - проверяют производительность ключевых запросов
4. **Оптимизация таблицы refresh_tokens**:
   - Удаление просроченных токенов
   - Удаление дубликатов токенов, оставляя только последние 5 для каждого пользователя
5. **Обновление статистики** - обновляют статистику для оптимизатора запросов

## Результаты

Результаты анализа сохраняются в директории `db_analysis_YYYYMMDD_HHMMSS`, где `YYYYMMDD_HHMMSS` - текущая дата и время.

В директории с результатами создаются следующие файлы:

- `indexes.txt` - информация об индексах
- `table_sizes.txt` - размеры таблиц и индексов
- `query_users_*.txt` - анализ запросов к таблице users
- `query_refresh_tokens_*.txt` - анализ запросов к таблице refresh_tokens
- `query_complex_join.txt` - анализ сложных запросов с JOIN
- `locks.txt` - информация о блокировках
- `long_queries.txt` - информация о долгих запросах

## Интерпретация результатов

### Как понять, что запрос требует оптимизации

1. **Время выполнения запроса**:
   - Запросы, выполняющиеся дольше 100 мс, требуют внимания
   - Запросы, выполняющиеся дольше 1 секунды, требуют немедленной оптимизации

2. **Анализ плана запроса (EXPLAIN ANALYZE)**:
   - **Sequential Scan** вместо **Index Scan** на больших таблицах указывает на отсутствие нужного индекса
   - Высокие значения **actual time** и **rows** указывают на неэффективность запроса
   - **Nested Loop** с большим количеством итераций может указывать на проблемы с JOIN

3. **Размер таблиц и индексов**:
   - Если размер индексов значительно превышает размер таблицы, возможно, есть избыточные индексы
   - Большие таблицы без индексов могут вызывать проблемы производительности

4. **Блокировки**:
   - Большое количество блокировок указывает на конкуренцию за ресурсы
   - Длительные блокировки могут вызывать задержки в работе приложения

### Рекомендации по оптимизации

На основе результатов анализа можно выполнить следующие оптимизации:

1. **Добавление индексов**:
   - Создавайте индексы для полей, используемых в условиях WHERE, JOIN и ORDER BY
   - Используйте составные индексы для запросов с несколькими условиями
   - Пример: `CREATE INDEX idx_field_name ON table_name(field_name)`

2. **Оптимизация запросов**:
   - Избегайте использования SELECT * и запрашивайте только нужные поля
   - Используйте LIMIT для ограничения количества возвращаемых строк
   - Оптимизируйте JOIN, используя правильные типы соединений

3. **Настройка PostgreSQL**:
   - Увеличьте `shared_buffers` для кэширования данных в памяти
   - Настройте `work_mem` для сложных операций сортировки и JOIN
   - Регулярно выполняйте VACUUM и ANALYZE для обновления статистики

4. **Мониторинг и профилактика**:
   - Регулярно анализируйте производительность базы данных
   - Настройте автоматическую очистку устаревших данных
   - Следите за ростом таблиц и своевременно архивируйте старые данные

## Требования

Для работы скриптов необходимо:

1. PostgreSQL клиент (psql)
2. Доступ к базе данных
3. Права на выполнение запросов EXPLAIN ANALYZE и ANALYZE 